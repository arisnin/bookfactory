<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bf.mapper.MyPageMapper">
	<resultMap type="com.bf.myPage.dto.MyPagePointDto" id="myPagePointDto">
		<result property="num" column="num"/>
		<result property="id" column="id"/>
		<result property="point" column="point"/>
		<result property="point_type" column="point_type"/>
		<result property="charge_date" column="charge_date"/>
		<result property="destory_date" column="destory_date"/>
		<result property="state" column="state"/>
	</resultMap>

	<insert id="point_insert" parameterType="com.bf.myPage.dto.MyPagePointDto">
		insert into point(num, id, point, point_type, state, remain)
		values(POINT_num_seq.nextval, #{id}, (SELECT CHARGE_CASH * PERCENTAGE / 100 "POINT"
		from CASH_CHARGE_MENU where id = #{point}), #{point_type}, #{state}, (SELECT CHARGE_CASH * PERCENTAGE / 100 "POINT"
		from CASH_CHARGE_MENU where id = #{point}))
	</insert>
	
	<insert id="cash_charge_insert" parameterType="com.bf.myPage.dto.MyPageCashChargeDto">
		INSERT INTO cash_charge
		VALUES(CASH_CHARGE_num_seq.nextval, #{id}, (SELECT charge_cash FROM CASH_CHARGE_MENU WHERE ID = #{charge_cash}),
		(SELECT num FROM POINT WHERE num = (SELECT MAX(num) FROM point)),
		#{charge_type_num}, SYSDATE, #{cash_type})
	</insert>
	
	<select id="point_select" parameterType="String" resultType="int">
		<![CDATA[
			SELECT sum(remain) FROM point
			WHERE destory_date - 11 < SYSDATE AND num in
			(SELECT num FROM point WHERE destory_date >= SYSDATE)
		]]>
	</select>
	
	<select id="point_select_list" parameterType="String" resultType="com.bf.myPage.dto.MyPagePointDto">
		select * from point where id = #{id} order by charge_date desc
	</select>
	
	<select id="cash_page_select_list" parameterType="String" resultType="com.bf.myPage.dto.MyPageCashPageDto">
		select cash_charge.CHARGE_DATE, cash_charge.CASH_TYPE, cash_charge.CHARGE_CASH, point.POINT, cash_charge_type.charge_type, cash_charge.ORDER_NUM from cash_charge, cash_charge_type, point where cash_charge.POINT_NUM = point.num and cash_charge.CHARGE_TYPE_NUM = cash_charge_type.num and cash_charge.id = #{id} order by charge_date desc
	</select>
	
	<select id="recent_page_select_list" parameterType="String" resultType="com.bf.myPage.dto.MyPageRecentPageDto">
		SELECT bm.book_num "book_num", bm.img_path "img_path", bm.NAME "book_name", A.NAME "author_name", rs."star_point", rs."star_count"
		FROM RECENT_LOOKBOOK rb, bookm bm, author A, 
		(SELECT round(sum(star_point) / count(star_point), 1) "star_point", count(star_point) "star_count", book_num FROM review GROUP BY book_num) rs
		WHERE bm.book_num = rb.book_num AND rb.book_num = rs.book_num(+) AND bm.author_num = A.num and rb.ID = #{id}
	</select>
	
	<select id="purchased_page_select_list" parameterType="String" resultType="com.bf.myPage.dto.MyPagePurchasedPageDto">
		select bm.book_num "book_num", bm.img_path "img_path", bm.NAME "book_name", A.NAME "author_name" from bookm bm, author a, payment pm where bm.book_num = pm.book_num and bm.author_num = a.num and pm.id = #{id} and pm.state = 'yes'
	</select>
	
	<update id="purchased_delete" parameterType="java.util.Map">
		update payment set state = 'no' where id = #{id} and book_num in 
		  <foreach item="item" index="index" collection="book_num"
		      open="(" separator="," close=")">
		        #{item}
		  </foreach>
	</update>
	
	<delete id="recent_delete" parameterType="String">
		delete from RECENT_LOOKBOOK where id = #{id}
	</delete>
	
	<select id="history_click_select" parameterType="java.util.Map" resultType="com.bf.order.dto.OrderDto">
		select cc.order_num, cc.cash_type, cc.CHARGE_CASH "PRICE", 0 "cash_use", 0 "point_use", cct.CHARGE_TYPE "pay_type", p.POINT
		from cash_charge cc, CASH_CHARGE_TYPE cct, point p
		where cc.id = #{id} and cc.ORDER_NUM= #{order_num} and cc.POINT_NUM = p.NUM and cct.NUM = cc.CHARGE_TYPE_NUM
	</select>
</mapper>